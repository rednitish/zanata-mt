<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>DocumentResourceImpl.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">mt-server</a> &gt; <a href="index.source.html" class="el_package">org.zanata.magpie.api.service.impl</a> &gt; <span class="el_source">DocumentResourceImpl.java</span></div><h1>DocumentResourceImpl.java</h1><pre class="source lang-java linenums">package org.zanata.magpie.api.service.impl;

import java.io.IOException;
import java.io.OutputStream;
import java.nio.charset.StandardCharsets;
import java.util.List;
import java.util.Map;
import java.util.Optional;
import java.util.Set;

import javax.annotation.Nullable;
import javax.enterprise.context.RequestScoped;
import javax.inject.Inject;
import javax.ws.rs.BadRequestException;
import javax.ws.rs.QueryParam;
import javax.ws.rs.WebApplicationException;
import javax.ws.rs.core.Context;
import javax.ws.rs.core.MediaType;
import javax.ws.rs.core.Response;
import javax.ws.rs.core.StreamingOutput;
import javax.ws.rs.core.UriInfo;

import com.google.common.collect.ImmutableMap;
import org.apache.commons.io.FilenameUtils;
import org.apache.commons.lang3.StringUtils;
import org.apache.commons.lang3.tuple.Pair;
import org.fedorahosted.tennera.jgettext.Message;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.zanata.magpie.annotation.BackEndProviders;
import org.zanata.magpie.annotation.DefaultProvider;
import org.zanata.magpie.annotation.DevMode;
import org.zanata.magpie.api.dto.APIResponse;
import org.zanata.magpie.api.dto.DocumentContent;
import org.zanata.magpie.api.dto.DocumentStatistics;
import org.zanata.magpie.api.dto.LocaleCode;
import org.zanata.magpie.api.dto.TranslateDocumentForm;
import org.zanata.magpie.api.dto.TypeString;
import org.zanata.magpie.api.service.BackendResource;
import org.zanata.magpie.api.service.DocumentResource;
import org.zanata.magpie.dao.LocaleDAO;
import org.zanata.magpie.filter.TranslationFileAdapter;
import org.zanata.magpie.filter.PoFileAdapter;
import org.zanata.magpie.model.BackendID;
import org.zanata.magpie.model.Document;
import org.zanata.magpie.model.Locale;
import org.zanata.magpie.dto.DateRange;
import org.zanata.magpie.service.DocumentContentTranslatorService;
import org.zanata.magpie.service.DocumentService;
import org.zanata.magpie.util.UrlUtil;

import static org.zanata.magpie.api.service.BackendResource.ATTRIBUTION_KEY;
import static org.zanata.magpie.model.BackendID.fromStringWithDefault;

/**
 * @author Alex Eng &lt;a href=&quot;mailto:aeng@redhat.com&quot;&gt;aeng@redhat.com&lt;/a&gt;
 */
@RequestScoped
public class DocumentResourceImpl implements DocumentResource {
<span class="fc" id="L60">    private static final Logger LOG =</span>
<span class="fc" id="L61">            LoggerFactory.getLogger(DocumentResourceImpl.class);</span>

    @Context
    protected UriInfo uriInfo;

    private DocumentContentTranslatorService documentContentTranslatorService;
    private LocaleDAO localeDAO;
    private BackendResource backendResourceImpl;
    private DocumentService documentService;
    private boolean isDevMode;
    private BackendID defaultProvider;
    private Set&lt;BackendID&gt; availableProviders;

<span class="fc" id="L74">    private static ImmutableMap&lt;String, TranslationFileAdapter&gt; FILTERS =</span>
<span class="fc" id="L75">        ImmutableMap.&lt;String, TranslationFileAdapter&gt;builder()</span>
<span class="fc" id="L76">            .put(&quot;POT&quot;, new PoFileAdapter(StandardCharsets.UTF_8))</span>
<span class="fc" id="L77">            .build();</span>

    @SuppressWarnings(&quot;unused&quot;)
<span class="fc" id="L80">    public DocumentResourceImpl() {</span>
<span class="fc" id="L81">    }</span>

    @Inject
    public DocumentResourceImpl(
        DocumentContentTranslatorService documentContentTranslatorService,
        LocaleDAO localeDAO,
        DocumentService documentService,
        BackendResource backendResourceImpl,
        @DevMode boolean isDevMode,
        @DefaultProvider BackendID defaultProvider,
<span class="fc" id="L91">        @BackEndProviders Set&lt;BackendID&gt; availableProviders) {</span>
<span class="fc" id="L92">        this.documentContentTranslatorService =</span>
                documentContentTranslatorService;
<span class="fc" id="L94">        this.localeDAO = localeDAO;</span>
<span class="fc" id="L95">        this.documentService = documentService;</span>
<span class="fc" id="L96">        this.backendResourceImpl = backendResourceImpl;</span>
<span class="fc" id="L97">        this.isDevMode = isDevMode;</span>
<span class="fc" id="L98">        this.defaultProvider = defaultProvider;</span>
<span class="fc" id="L99">        this.availableProviders = availableProviders;</span>
<span class="fc" id="L100">    }</span>

    @Override
    public Response getStatistics(@QueryParam(&quot;url&quot;) String url,
            @QueryParam(&quot;fromLocaleCode&quot;) LocaleCode fromLocaleCode,
            @QueryParam(&quot;toLocaleCode&quot;) LocaleCode toLocaleCode,
            @QueryParam(&quot;dateRange&quot;) String dateRangeParam) {
<span class="fc bfc" id="L107" title="All 2 branches covered.">        if (StringUtils.isBlank(url)) {</span>
<span class="fc" id="L108">            APIResponse response =</span>
                    new APIResponse(Response.Status.BAD_REQUEST, &quot;Empty url&quot;);
<span class="fc" id="L110">            return Response.status(response.getStatus()).entity(response)</span>
<span class="fc" id="L111">                    .build();</span>
        }

<span class="fc" id="L114">        Optional&lt;DateRange&gt; dateParam =</span>
<span class="pc bpc" id="L115" title="1 of 2 branches missed.">            StringUtils.isBlank(dateRangeParam) ? Optional.empty() :</span>
<span class="pc" id="L116">                Optional.of(DateRange.from(dateRangeParam));</span>

        // TODO this could be faster if we eagerly fetch the TextFlows for all Documents
<span class="fc" id="L119">        List&lt;Document&gt; documents = documentService</span>
<span class="fc" id="L120">            .getByUrl(url, Optional.ofNullable(fromLocaleCode),</span>
<span class="fc" id="L121">                Optional.ofNullable(toLocaleCode), dateParam);</span>

<span class="fc" id="L123">        DocumentStatistics statistics = new DocumentStatistics(url);</span>
<span class="fc bfc" id="L124" title="All 2 branches covered.">        for (Document document: documents) {</span>
<span class="fc" id="L125">            int wordCount = getTotalWordCount(document,</span>
<span class="fc" id="L126">                document.getFromLocale().getLocaleCode());</span>

<span class="fc" id="L128">            statistics.addRequestCount(</span>
<span class="fc" id="L129">                document.getFromLocale().getLocaleCode().getId(),</span>
<span class="fc" id="L130">                document.getToLocale().getLocaleCode().getId(),</span>
<span class="fc" id="L131">                document.getCount(), wordCount);</span>
<span class="fc" id="L132">        }</span>
<span class="fc" id="L133">        return Response.ok().entity(statistics).build();</span>
    }

    // lazily loads the text flows in doc
    private int getTotalWordCount(Document doc, LocaleCode localeCode) {
<span class="fc" id="L138">        return doc.getTextFlows().values().stream()</span>
<span class="pc" id="L139">                .filter(tf -&gt; tf.getLocale().getLocaleCode()</span>
<span class="nc" id="L140">                        .equals(localeCode))</span>
<span class="pc" id="L141">                .mapToInt(tf -&gt; tf.getWordCount().intValue())</span>
<span class="fc" id="L142">                .sum();</span>
    }

    @Override
    public Response translate(DocumentContent docContent,
        @QueryParam(&quot;toLocaleCode&quot;) LocaleCode toLocaleCode) {

<span class="fc" id="L149">        Optional&lt;APIResponse&gt; errorResp =</span>
<span class="fc" id="L150">            validateTranslateRequest(docContent, toLocaleCode);</span>
<span class="fc bfc" id="L151" title="All 2 branches covered.">        if (errorResp.isPresent()) {</span>
<span class="fc" id="L152">            return Response.status(errorResp.get().getStatus())</span>
<span class="fc" id="L153">                .entity(errorResp.get()).build();</span>
        }

        // use dev backend if it's DEV mode
<span class="fc bfc" id="L157" title="All 2 branches covered.">        final BackendID backendID = isDevMode ? BackendID.DEV</span>
<span class="fc" id="L158">            : fromStringWithDefault(docContent.getBackendId(),</span>
            defaultProvider);

        // check if this backend is available
<span class="pc bpc" id="L162" title="1 of 2 branches missed.">        if (!availableProviders.contains(backendID)) {</span>
<span class="nc" id="L163">            LOG.warn(</span>
                &quot;requested machine translation provider {} is not set up (no credential)&quot;,
                backendID);
<span class="nc" id="L166">            return Response.status(Response.Status.NOT_IMPLEMENTED)</span>
<span class="nc" id="L167">                .entity(new APIResponse(Response.Status.NOT_IMPLEMENTED,</span>
<span class="nc" id="L168">                    &quot;Error: backendId &quot; + docContent.getBackendId() +</span>
<span class="nc" id="L169">                        &quot; not available&quot;)).build();</span>
        }

        // if source locale == target locale, return docContent
<span class="fc" id="L173">        LocaleCode fromLocaleCode = new LocaleCode(docContent.getLocaleCode());</span>
<span class="fc bfc" id="L174" title="All 2 branches covered.">        if (fromLocaleCode.equals(toLocaleCode)) {</span>
<span class="fc" id="L175">            LOG.info(</span>
                &quot;Returning unchanged request, FROM and TO localeCode are the same {}&quot;,
                fromLocaleCode);
<span class="fc" id="L178">            return Response.ok().entity(docContent).build();</span>
        }

<span class="pc bpc" id="L181" title="1 of 2 branches missed.">        if (LOG.isDebugEnabled()) {</span>
<span class="nc" id="L182">            LOG.debug(&quot;Request translations: {} toLocaleCode {} backendId: {}&quot;,</span>
<span class="nc" id="L183">                docContent, toLocaleCode, backendID.getId());</span>
        }

<span class="fc" id="L186">        Locale fromLocale = getLocale(fromLocaleCode);</span>
<span class="fc" id="L187">        Locale toLocale = getLocale(toLocaleCode);</span>

<span class="fc" id="L189">        Document doc = documentService</span>
<span class="fc" id="L190">            .getOrCreateByUrl(docContent.getUrl(), fromLocale,</span>
                toLocale);
<span class="fc" id="L192">        documentService.incrementDocRequestCount(doc);</span>

<span class="fc" id="L194">        DocumentContent newDocContent = documentContentTranslatorService</span>
<span class="fc" id="L195">            .translateDocument(doc, docContent, backendID);</span>
<span class="fc" id="L196">        return Response.ok().entity(newDocContent).build();</span>
    }

    @Override
    public Response translateFile(TranslateDocumentForm form,
        LocaleCode fromLocaleCode, LocaleCode toLocaleCode) {

<span class="pc bpc" id="L203" title="2 of 4 branches missed.">        if (fromLocaleCode == null || toLocaleCode == null) {</span>
<span class="nc" id="L204">            APIResponse apiResponse =</span>
                new APIResponse(Response.Status.BAD_REQUEST,
                    &quot;Null query param: fromLocaleCode or toLocaleCode&quot;);
<span class="nc" id="L207">            return Response.status(apiResponse.getStatus())</span>
<span class="nc" id="L208">                .entity(apiResponse).build();</span>
        }

<span class="pc bpc" id="L211" title="1 of 2 branches missed.">        if (StringUtils.isBlank(form.getFileName())) {</span>
<span class="nc" id="L212">            APIResponse apiResponse =</span>
                new APIResponse(Response.Status.BAD_REQUEST,
                    &quot;Null form param: fileName&quot;);
<span class="nc" id="L215">            return Response.status(apiResponse.getStatus())</span>
<span class="nc" id="L216">                .entity(apiResponse).build();</span>
        }

        try {
<span class="fc" id="L220">            String fileExt = FilenameUtils.getExtension(form.getFileName());</span>
<span class="fc" id="L221">            TranslationFileAdapter adapter = FILTERS.get(fileExt.toUpperCase());</span>

<span class="fc" id="L223">            String url = getURL(uriInfo.getRequestUri().toString(), form.getFileName());</span>
<span class="fc" id="L224">            Pair&lt;DocumentContent, Map&lt;String, Message&gt;&gt; contents = adapter</span>
<span class="fc" id="L225">                .parseSourceDocument(form.getFileStream(), url, fromLocaleCode);</span>

<span class="fc" id="L227">            Response response = this.translate(contents.getLeft(), toLocaleCode);</span>
<span class="pc bpc" id="L228" title="1 of 2 branches missed.">            if (response.getStatus() != Response.Status.OK.getStatusCode()) {</span>
<span class="nc" id="L229">                return response;</span>
            }
<span class="fc" id="L231">            DocumentContent newDocContent =</span>
<span class="fc" id="L232">                (DocumentContent) response.getEntity();</span>
<span class="fc" id="L233">            Response attr = backendResourceImpl</span>
<span class="fc" id="L234">                .getStringAttribution(newDocContent.getBackendId());</span>
<span class="pc bpc" id="L235" title="1 of 2 branches missed.">            String attribution = attr != null &amp;&amp;</span>
<span class="pc bpc" id="L236" title="1 of 2 branches missed.">                attr.getStatus() == Response.Status.OK.getStatusCode() ?</span>
<span class="pc" id="L237">                ATTRIBUTION_KEY + &quot;:&quot; + attr.getEntity().toString() : &quot;&quot;;</span>

<span class="fc" id="L239">            FilterStreamingOutput stream =</span>
                new FilterStreamingOutput(adapter, newDocContent,
<span class="fc" id="L241">                    contents.getRight(), fromLocaleCode,</span>
                    toLocaleCode, attribution);

<span class="fc" id="L244">            String docName =</span>
<span class="fc" id="L245">                getTransFilename(adapter.getTranslationFileExtension(),</span>
<span class="fc" id="L246">                    form.getFileName(), toLocaleCode.getId());</span>

<span class="fc" id="L248">            return Response.ok(stream, MediaType.APPLICATION_OCTET_STREAM)</span>
<span class="fc" id="L249">                .header(&quot;content-disposition&quot;,</span>
                    &quot;attachment; filename=\&quot;&quot; + docName + &quot;\&quot;&quot;)
<span class="fc" id="L251">                .header(&quot;Access-Control-Expose-Headers&quot;,</span>
                    &quot;content-disposition&quot;)
<span class="fc" id="L253">                .build();</span>
<span class="nc" id="L254">        } catch (Exception e) {</span>
<span class="nc" id="L255">            APIResponse apiResponse =</span>
                new APIResponse(Response.Status.BAD_REQUEST,
                    e, &quot;Unable to parse document&quot;);
<span class="nc" id="L258">            LOG.error(apiResponse.getDetails(), e);</span>
<span class="nc" id="L259">            return Response.status(apiResponse.getStatus())</span>
<span class="nc" id="L260">                .entity(apiResponse).build();</span>
        }
    }

    private String getURL(String requestURL, String fileName) {
<span class="pc bpc" id="L265" title="1 of 2 branches missed.">        String url = requestURL.endsWith(&quot;/&quot;) ? requestURL.substring(0, requestURL.length() - 1) : requestURL;</span>
<span class="pc bpc" id="L266" title="1 of 2 branches missed.">        String name = &quot;&amp;name=&quot; + (fileName.startsWith(&quot;/&quot;) ?  fileName.substring(1) : fileName);</span>
<span class="fc" id="L267">        return url + name;</span>
    }

    private String getTransFilename(String ext, String filename,
        String localeCode) {
<span class="fc" id="L272">        String transFilename =</span>
<span class="fc" id="L273">            FilenameUtils.removeExtension(filename) + &quot;_&quot; +</span>
                localeCode + &quot;.&quot; + ext;
<span class="fc" id="L275">        return transFilename;</span>
    }

    private Optional&lt;APIResponse&gt; validateTranslateRequest(
        DocumentContent docContent,
        LocaleCode toLocaleCode) {
<span class="fc bfc" id="L281" title="All 2 branches covered.">        if (toLocaleCode == null) {</span>
<span class="fc" id="L282">            return Optional.of(new APIResponse(Response.Status.BAD_REQUEST,</span>
                &quot;Invalid query param: toLocaleCode&quot;));
        }
<span class="pc bpc" id="L285" title="1 of 4 branches missed.">        if (docContent == null || docContent.getContents() == null ||</span>
<span class="pc bpc" id="L286" title="1 of 2 branches missed.">            docContent.getContents().isEmpty()) {</span>
<span class="fc" id="L287">            return Optional.of(new APIResponse(Response.Status.BAD_REQUEST,</span>
                &quot;Empty content: &quot; + docContent));
        }
<span class="fc bfc" id="L290" title="All 2 branches covered.">        if (StringUtils.isBlank(docContent.getLocaleCode())) {</span>
<span class="fc" id="L291">            return Optional.of(new APIResponse(Response.Status.BAD_REQUEST,</span>
                &quot;Blank localeCode&quot;));
        }
<span class="fc bfc" id="L294" title="All 2 branches covered.">        if (StringUtils.isBlank(docContent.getUrl()) ||</span>
<span class="pc bpc" id="L295" title="1 of 2 branches missed.">            !UrlUtil.isValidURL(docContent.getUrl())) {</span>
<span class="fc" id="L296">            return Optional.of(new APIResponse(Response.Status.BAD_REQUEST,</span>
<span class="fc" id="L297">                &quot;Invalid url: &quot; + docContent.getUrl()));</span>
        }
<span class="fc bfc" id="L299" title="All 2 branches covered.">        for (TypeString string : docContent.getContents()) {</span>
<span class="fc" id="L300">            if (!documentContentTranslatorService</span>
<span class="fc bfc" id="L301" title="All 2 branches covered.">                .isMediaTypeSupported(string.getType())) {</span>
<span class="fc" id="L302">                return Optional</span>
<span class="fc" id="L303">                    .of(new APIResponse(Response.Status.BAD_REQUEST,</span>
<span class="fc" id="L304">                        &quot;Unsupported media type: &quot; + string.getType()));</span>
            }
<span class="fc" id="L306">        }</span>
<span class="fc" id="L307">        return Optional.empty();</span>
    }

    private @Nullable
    Locale getLocale(LocaleCode localeCode) throws BadRequestException {
<span class="pc bpc" id="L312" title="1 of 2 branches missed.">        if (localeCode == null) {</span>
<span class="nc" id="L313">            return null;</span>
        }
<span class="fc" id="L315">        Locale locale = localeDAO.getByLocaleCode(localeCode);</span>
<span class="fc bfc" id="L316" title="All 2 branches covered.">        if (locale != null) {</span>
<span class="fc" id="L317">            return locale;</span>
        }
<span class="fc" id="L319">        LocaleCode langCode = new LocaleCode(localeCode.getLanguage());</span>
<span class="fc" id="L320">        Locale langLocale = localeDAO.getByLocaleCode(langCode);</span>
<span class="pc bpc" id="L321" title="1 of 2 branches missed.">        if (langLocale != null) {</span>
<span class="fc" id="L322">            return langLocale;</span>
        }
<span class="nc" id="L324">        throw new BadRequestException(</span>
            &quot;Unsupported locale: &quot; + localeCode);
    }

    protected static class FilterStreamingOutput implements StreamingOutput {
        protected final TranslationFileAdapter filter;
        protected final DocumentContent translatedDocContent;
        protected final LocaleCode fromLocaleCode;
        protected final LocaleCode toLocaleCode;
        protected final String attribution;
        protected final Map&lt;String, Message&gt; messages;

        FilterStreamingOutput(TranslationFileAdapter filter,
            DocumentContent translatedDocContent, Map&lt;String, Message&gt; messages,
            LocaleCode fromLocaleCode, LocaleCode toLocaleCode,
<span class="fc" id="L339">            String attribution) {</span>
<span class="fc" id="L340">            this.filter = filter;</span>
<span class="fc" id="L341">            this.translatedDocContent = translatedDocContent;</span>
<span class="fc" id="L342">            this.messages = messages;</span>
<span class="fc" id="L343">            this.fromLocaleCode = fromLocaleCode;</span>
<span class="fc" id="L344">            this.toLocaleCode = toLocaleCode;</span>
<span class="fc" id="L345">            this.attribution = attribution;</span>
<span class="fc" id="L346">        }</span>

        @Override
        public void write(OutputStream output)
            throws IOException, WebApplicationException {
<span class="fc" id="L351">            filter.writeTranslatedFile(output, fromLocaleCode,</span>
                toLocaleCode, translatedDocContent, messages, attribution);
<span class="fc" id="L353">        }</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.2.201808211720</span></div></body></html>